name: Build Android APK  li

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk python3-pip \
          autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev libtinfo5 \
          cmake libffi-dev libssl-dev automake libltdl-dev \
          aidl
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer==1.5.0 cython==0.29.36
    
    - name: Generate keystore
      run: |
        rm -f htac-release-key.keystore
        keytool -genkey -v \
          -keystore htac-release-key.keystore \
          -alias htac \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -dname "CN=HTAC, OU=Engineering, O=HTAC, L=Beijing, ST=Beijing, C=CN" \
          -storepass htac123456 -keypass htac123456
    
    - name: Update buildozer.spec
      run: |
        sed -i 's|# android.keystore =|android.keystore = htac-release-key.keystore|' buildozer.spec
        sed -i 's|# android.keystore_password =|android.keystore_password = htac123456|' buildozer.spec
        sed -i 's|# android.keyalias =|android.keyalias = htac|' buildozer.spec
        sed -i 's|# android.keyalias_password =|android.keyalias_password = htac123456|' buildozer.spec
        sed -i 's|log_level =.*|log_level = 2|' buildozer.spec
        # 只构建arm64以节省时间和内存
        sed -i 's|android.archs =.*|android.archs = arm64-v8a|' buildozer.spec || echo "android.archs = arm64-v8a" >> buildozer.spec
    
    - name: Build APK
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        buildozer android release
      timeout-minutes: 120
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: condenser-calc-apk
        path: bin/*.apk
        retention-days: 30
